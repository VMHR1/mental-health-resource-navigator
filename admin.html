<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Program Submission • Adolescent Mental Health Directory</title>
  <style>
    :root{
      --bg: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --card: rgba(255,255,255,0.92);
      --border: rgba(15,23,42,0.10);

      --accent: #f97316;   /* warm orange */
      --accent2:#fb7185;   /* warm rose */
      --accent3:#22c55e;   /* gentle green */
      --shadow: 0 20px 60px rgba(2, 8, 23, 0.10);
      --shadow2: 0 10px 30px rgba(2, 8, 23, 0.08);

      --radius: 18px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(249,115,22,0.12), transparent 60%),
        radial-gradient(1000px 700px at 110% 20%, rgba(251,113,133,0.10), transparent 55%),
        radial-gradient(900px 700px at 40% 110%, rgba(34,197,94,0.08), transparent 55%),
        var(--bg);
      color: var(--text);
    }

    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    header{
      display:flex;
      justify-content: space-between;
      gap: 16px;
      align-items: flex-start;
      margin-bottom: 18px;
    }

    .titleblock h1{
      font-size: 26px;
      margin:0 0 6px 0;
      letter-spacing: -0.02em;
    }
    .titleblock p{
      margin:0;
      color: var(--muted);
      line-height: 1.35;
      max-width: 62ch;
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    button, .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.75);
      border-radius: 999px;
      padding: 10px 12px;
      cursor: pointer;
      color: var(--text);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 0 0 rgba(0,0,0,0);
      font-weight: 600;
      font-size: 13px;
      white-space: nowrap;
    }

    button:hover{
      transform: translateY(-1px);
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,0.92);
    }

    .pill{
      cursor: default;
      display:flex; align-items:center; gap:8px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 8px 18px rgba(249,115,22,0.20);
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }

    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(120deg, rgba(249,115,22,0.18), rgba(251,113,133,0.16), rgba(34,197,94,0.14));
      filter: blur(18px);
      opacity: 0.50;
      z-index: 0;
      pointer-events: none;
    }

    .card-inner{
      position: relative;
      z-index: 1;
      padding: 18px;
    }

    .progress-wrap{
      display:flex;
      gap: 14px;
      align-items: center;
      margin: 10px 0 16px;
    }

    .progress{
      flex: 1;
      height: 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.65);
      overflow: hidden;
    }
    .bar{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .35s ease;
    }

    .step-title{
      font-weight: 800;
      letter-spacing: -0.01em;
      margin: 0 0 4px;
    }
    .step-sub{
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .stepper{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap: 8px;
      margin: 10px 0 18px;
    }

    .step-chip{
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.65);
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 8px;
      align-items:center;
      transition: transform .15s ease, background .15s ease, box-shadow .15s ease;
    }

    .step-chip.active{
      color: var(--text);
      background: rgba(255,255,255,0.92);
      box-shadow: var(--shadow2);
      transform: translateY(-1px);
    }

    .badge{
      width: 20px; height: 20px;
      border-radius: 999px;
      display:grid; place-items:center;
      font-weight: 900;
      color: white;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(249,115,22,0.20);
      flex: 0 0 auto;
    }

    form{
      margin-top: 6px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 12px;
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
      header{ flex-direction: column; align-items: stretch; }
      .actions{ justify-content: flex-start; }
      .stepper{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    label{
      display:block;
      font-weight: 800;
      font-size: 13px;
      margin: 0 0 6px;
      letter-spacing: -0.01em;
    }
    .help{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    input, select, textarea{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.88);
      outline: none;
      transition: box-shadow .15s ease, transform .15s ease, border-color .15s ease;
      color: var(--text);
      font-size: 14px;
    }

    textarea{ min-height: 110px; resize: vertical; }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(249,115,22,0.35);
      box-shadow: 0 0 0 6px rgba(249,115,22,0.10);
    }

    .row{
      margin-bottom: 14px;
    }

    .multi{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .check{
      display:flex;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.70);
      cursor: pointer;
      user-select: none;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .check:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); background: rgba(255,255,255,0.92); }

    .check input{ width:auto; margin:0; }

    .alert{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(249,115,22,0.35);
      background: rgba(249,115,22,0.08);
      color: #7c2d12;
      font-size: 13px;
      line-height: 1.35;
      display:none;
    }
    .alert.show{ display:block; animation: pop .22s ease; }

    .success{
      border-color: rgba(34,197,94,0.35);
      background: rgba(34,197,94,0.08);
      color: #14532d;
    }

    @keyframes pop{
      from{ transform: translateY(6px); opacity: 0; }
      to{ transform: translateY(0); opacity: 1; }
    }

    .footer{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 18px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
    }

    .btn-primary{
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      box-shadow: 0 14px 30px rgba(249,115,22,0.22);
    }
    .btn-primary:hover{ transform: translateY(-1px); box-shadow: 0 18px 40px rgba(249,115,22,0.26); }

    .btn-ghost{
      background: rgba(255,255,255,0.55);
    }

    .fade-enter{
      animation: enter .28s ease both;
    }
    @keyframes enter{
      from{ opacity: 0; transform: translateY(10px); }
      to{ opacity: 1; transform: translateY(0); }
    }

    .mini{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .kpi{
      display:flex; gap:10px; flex-wrap: wrap;
      margin-top: 8px;
    }
    .kpi .pill{ background: rgba(255,255,255,0.60); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="titleblock">
        <h1>Program Submission</h1>
        <p>Provide factual information families can use to understand access, logistics, and expectations. Listings are not ranked and should avoid marketing language or outcome guarantees.</p>
        <div class="kpi">
          <div class="pill"><span class="dot"></span><span>Neutral by design</span></div>
          <div class="pill"><span class="dot"></span><span>Supports insurance & language access</span></div>
          <div class="pill"><span class="dot"></span><span>Verification-ready</span></div>
        </div>
      </div>
      <div class="actions">
        <button id="saveDraft" type="button">Save draft</button>
        <button id="loadDraft" type="button">Load draft</button>
        <button id="clearDraft" type="button">Clear</button>
      </div>
    </header>

    <div class="card">
      <div class="card-inner">
        <div class="progress-wrap">
          <div class="progress" aria-label="progress">
            <div id="bar" class="bar"></div>
          </div>
          <div class="pill"><span class="dot"></span><span id="progressLabel">Step 1 of 6</span></div>
        </div>

        <div class="stepper" id="stepper"></div>

        <div>
          <p class="step-title" id="stepTitle"></p>
          <p class="step-sub" id="stepSub"></p>
        </div>

        <div id="alert" class="alert"></div>

        <form id="wizard" novalidate></form>

        <input id="_gotcha" type="text" style="display:none" tabindex="-1" autocomplete="off" aria-hidden="true" />

        <div class="footer">
          <button id="backBtn" type="button" class="btn-ghost">Back</button>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="nextBtn" type="button" class="btn-primary">Next</button>
          </div>
        </div>

        <p class="mini" style="margin-top:12px;">
          Crisis guidance shown on the public directory is separate. Do not submit patient information or protected health information (PHI).
        </p>
      </div>
    </div>
  </div>

  <script>
    // --- Wizard configuration ---
    const steps = [
      {
        key: "org",
        title: "Organization basics",
        sub: "Public-facing organization info + internal verification contact.",
        fields: [
          { id:"org_name", label:"Organization name *", type:"text", required:true, ph:"ABC Behavioral Health", help:"Use the name families will recognize." },
          { id:"org_type", label:"Organization type *", type:"select", required:true, options:[
            "", "Hospital/Health System", "Community Mental Health Center", "Private Practice/Group", "Nonprofit",
            "Residential/Treatment Network", "School-based Provider", "Other"
          ], help:"Used for categorization only; not displayed as quality." },
          { id:"website_url", label:"Organization website (optional)", type:"url", required:false, ph:"https://", help:"A public page helps families confirm details." },
          { id:"general_phone", label:"General phone *", type:"tel", required:true, ph:"(214) 555-0123", help:"Public number families can call." },
          { id:"general_email", label:"General email (optional)", type:"email", required:false, ph:"info@org.org", help:"Optional public contact email." },
          { id:"admin_contact_name", label:"Listing owner name (internal) *", type:"text", required:true, ph:"Jane Smith", help:"Used only for verification and updates." },
          { id:"admin_contact_email", label:"Listing owner email (internal) *", type:"email", required:true, ph:"jane@org.org", help:"Used only for verification and updates." },
        ]
      },
      {
        key: "program",
        title: "Program overview",
        sub: "What the program is, who it serves, and how it is delivered.",
        fields: [
          { id:"program_name", label:"Program name *", type:"text", required:true, ph:"Adolescent IOP – Plano", help:"Use a location tag if you have multiple sites." },
          { id:"level_of_care", label:"Level of care *", type:"select", required:true, options:[
            "", "Crisis services", "Inpatient psychiatric", "Residential", "Partial Hospitalization (PHP)", "Intensive Outpatient (IOP)",
            "Outpatient therapy", "Outpatient psychiatry/medication management", "Assessment/Evaluation", "Other"
          ], help:"Displayed as an informational tag (not a recommendation)." },
          { id:"service_setting", label:"Service setting *", type:"select", required:true, options:["", "In-person", "Telehealth", "Hybrid"], help:"Used for filtering." },
          { id:"population", label:"Primary population served *", type:"multicheck", required:true, options:["Adolescents (12–17)","Children (5–11)","Young adults (18–25)","Families/Caregivers"], help:"Select all that apply." },
          { id:"program_description_public", label:"Program description (plain language) *", type:"textarea", required:true,
            ph:"Briefly describe what services are typically included and what families can expect. Avoid marketing claims or outcome guarantees.",
            help:"Factual, neutral, plain language. Avoid: 'best', 'premier', 'guaranteed results'." },
          { id:"clinical_focus_tags", label:"Clinical focus areas (optional)", type:"multicheck", required:false,
            options:["Depression/mood","Anxiety","Trauma","SI/NSSI support","Eating concerns","Substance use","OCD","ADHD","Autism/neurodiversity support","Behavioral concerns","Grief/loss","Family conflict","Other"],
            help:"Optional; helps families filter." },
          { id:"family_involvement", label:"Family involvement *", type:"select", required:true, options:["","Required","Optional","Varies by patient","Not specified"], help:"Displayed as a neutral attribute." },
          { id:"school_coordination", label:"School coordination (optional)", type:"select", required:false, options:["","Yes","No","Varies/Case-by-case","Not specified"], help:"Helpful for school-aged adolescents." },
        ]
      },
      {
        key: "eligibility",
        title: "Eligibility & location",
        sub: "Age range and at least one site (if in-person or hybrid).",
        fields: [
          { id:"min_age", label:"Minimum age *", type:"number", required:true, ph:"12", help:"Use your typical minimum age." },
          { id:"max_age", label:"Maximum age *", type:"number", required:true, ph:"17", help:"Use your typical maximum age." },
          { id:"inclusion_notes", label:"Inclusion notes (optional)", type:"textarea", required:false, ph:"Any relevant eligibility notes in plain language.", help:"Keep neutral and factual." },
          { id:"exclusion_notes", label:"Limitations / not appropriate for (optional)", type:"textarea", required:false, ph:"Example: May not be appropriate for individuals needing immediate medical stabilization.", help:"Avoid stigmatizing language; keep it practical." },
          { id:"location_city", label:"Primary city (required for in-person/hybrid)", type:"text", required:false, ph:"Plano", help:"If telehealth-only, you may leave this blank." },
          { id:"location_zip", label:"Primary ZIP (required for in-person/hybrid)", type:"text", required:false, ph:"75024", help:"Used for distance filtering." },
          { id:"service_area_notes", label:"Service area notes (optional)", type:"text", required:false, ph:"DFW only, or Texas statewide via telehealth", help:"Helps statewide scaling." },
        ]
      },
      {
        key: "intake",
        title: "Access & intake",
        sub: "Referral requirements, intake steps, and contact pathways.",
        fields: [
          { id:"self_referral", label:"Self-referral accepted *", type:"select", required:true, options:["","Yes","No","Varies","Unknown"], help:"Can families contact you directly?" },
          { id:"referral_required", label:"Referral required *", type:"select", required:true, options:["","Yes","No","Varies","Unknown"], help:"Used for filtering and expectation-setting." },
          { id:"referral_sources_allowed", label:"Who can refer (optional)", type:"multicheck", required:false,
            options:["Parent/guardian","Therapist","Primary care","ED/hospital","School counselor","Other"], help:"Select all that apply." },
          { id:"intake_steps", label:"Intake steps *", type:"multicheck", required:true,
            options:["Phone screening","Clinical assessment","Insurance verification/authorization","Scheduling","Other"], help:"Select at least one." },
          { id:"documents_required", label:"Documents commonly requested (optional)", type:"multicheck", required:false,
            options:["ID","Insurance card","Prior treatment records (if available)","School information","Consent forms","Other"], help:"Optional but helpful for families." },
          { id:"intake_phone", label:"Intake phone (recommended)", type:"tel", required:false, ph:"(214) 555-0456", help:"At least one intake contact method is required." },
          { id:"intake_email", label:"Intake email (optional)", type:"email", required:false, ph:"intake@org.org", help:"Provide if monitored." },
          { id:"after_hours_process", label:"After-hours process (optional)", type:"textarea", required:false, ph:"Briefly explain how to reach your team after hours, if applicable.", help:"Do not replace emergency guidance; keep neutral." },
        ]
      },
      {
        key: "access",
        title: "Insurance, language, accessibility",
        sub: "Access details families use to determine feasibility.",
        fields: [
          { id:"payment_types", label:"Insurance / payment types accepted *", type:"multicheck", required:true,
            options:["Commercial","Medicaid","CHIP","Self-pay","Sliding scale","Other","Unknown"], help:"Select all that apply." },
          { id:"payer_names", label:"Common payers (optional)", type:"text", required:false, ph:"Aetna, BCBS, UnitedHealthcare", help:"Optional. Coverage depends on plan details." },
          { id:"prior_auth_required", label:"Prior authorization *", type:"select", required:true, options:["","Yes","No","Varies","Unknown"], help:"Families often ask this early." },
          { id:"financial_assistance_available", label:"Financial assistance available *", type:"select", required:true, options:["","Yes","No","Unknown"], help:"If yes, add details in your public website; keep this short." },
          { id:"languages", label:"Languages available *", type:"multicheck", required:true,
            options:["English","Spanish","Vietnamese","Chinese (Mandarin)","Arabic","Other"], help:"Select at least one." },
          { id:"interpreter_available", label:"Interpreter services *", type:"select", required:true, options:["","Yes","No","Unknown"], help:"Shown as a filter option." },
          { id:"accessibility_features", label:"Accessibility accommodations (optional)", type:"multicheck", required:false,
            options:["Wheelchair accessible","Sensory-friendly options","ASL/Deaf services","Other"], help:"Optional; reduces barriers." },
        ]
      },
      {
        key: "verify",
        title: "Availability & verification",
        sub: "Set expectations without guarantees; finalize listing.",
        fields: [
          { id:"accepting_new_patients", label:"Accepting new patients *", type:"select", required:true, options:["","Yes","No","Unknown"], help:"Avoid time promises; this may change quickly." },
          { id:"waitlist_status", label:"Waitlist status *", type:"select", required:true, options:["","None","Short","Moderate","Long","Unknown"], help:"Shown as informational only." },
          { id:"typical_time_to_intake", label:"Typical time to intake (optional)", type:"select", required:false,
            options:["","0–7 days","1–2 weeks","2–4 weeks","4–8 weeks","8+ weeks","Unknown"], help:"Displayed as typical, not guaranteed." },
          { id:"source_of_update", label:"Source of update *", type:"select", required:true, options:["","Updated by program staff","Updated by organization admin","Updated by moderator from public sources","Other"], help:"Used to display transparency." },
          { id:"attest", label:"Attestation *", type:"checkbox", required:true, help:"I confirm the information provided is accurate to the best of my knowledge and I will update it if it changes." },
        ]
      }
    ];

    const marketingSoftBlock = [
      "best","top","premier","world-class","unmatched","guarantee","guaranteed","cure","miracle","#1","number one","life-changing"
    ];


// --- Submission receiver (email-only manual review via Formspree) ---
// 1) Create a form in Formspree
// 2) Set notification email to: viablementalhealthresources@gmail.com
// 3) Paste your endpoint below (looks like https://formspree.io/f/xxxxxxx)
const FORMSPREE_ENDPOINT = "https://formspree.io/f/mjgbelej";

function getHoneypotValue(){
  const hp = document.getElementById("_gotcha");
  return hp ? (hp.value || "") : "";
}

async function submitToFormspree(payload){
  if(!FORMSPREE_ENDPOINT || FORMSPREE_ENDPOINT.includes("YOUR_FORM_ID")){
    throw new Error("FORM_ENDPOINT_NOT_CONFIGURED");
  }

  const fd = new FormData();

  // Human-readable fields for the email
  fd.append("Organization", payload.org_name || "");
  fd.append("Program", payload.program_name || "");
  fd.append("Level of care", payload.level_of_care || "");
  fd.append("Service setting", payload.service_setting || "");
  fd.append("Age range", `${payload.min_age || ""}–${payload.max_age || ""}`);
  fd.append("Primary city", payload.location_city || "");
  fd.append("Primary ZIP", payload.location_zip || "");
  fd.append("Website", payload.website_url || "");
  fd.append("General phone", payload.general_phone || "");
  fd.append("General email", payload.general_email || "");
  fd.append("Listing owner (internal)", payload.admin_contact_name || "");
  fd.append("Listing owner email (internal)", payload.admin_contact_email || "");
  fd.append("Submitted at", payload._submittedAt || "");

  // Full payload (easy for moderator to copy/paste into programs.json)
  fd.append("Full JSON", JSON.stringify(payload, null, 2));

  // Email behavior hints (supported by Formspree)
  fd.append("_subject", `New program submission: ${payload.program_name || payload.org_name || "Program"}`);
  fd.append("_replyto", payload.admin_contact_email || payload.general_email || "");

  // Honeypot (hidden field)
  fd.append("_gotcha", getHoneypotValue());

  const res = await fetch(FORMSPREE_ENDPOINT, {
    method: "POST",
    body: fd,
    headers: { "Accept": "application/json" }
  });

  if(!res.ok){
    let detail = "";
    try{
      const data = await res.json();
      if(data && data.errors){
        detail = data.errors.map(e => e.message).join(", ");
      }
    }catch(_){}
    throw new Error(detail || `Submission failed (${res.status})`);
  }
  return true;
}
    // --- State ---
    let stepIndex = 0;
    const formEl = document.getElementById("wizard");
    const alertEl = document.getElementById("alert");
    const barEl = document.getElementById("bar");
    const progressLabel = document.getElementById("progressLabel");
    const stepTitle = document.getElementById("stepTitle");
    const stepSub = document.getElementById("stepSub");
    const stepperEl = document.getElementById("stepper");

    // --- Helpers ---
    function showAlert(msg, type="warn"){
      alertEl.className = "alert show" + (type==="success" ? " success" : "");
      alertEl.textContent = msg;
    }
    function clearAlert(){
      alertEl.className = "alert";
      alertEl.textContent = "";
    }

    function percent(){
      return Math.round(((stepIndex+1) / steps.length) * 100);
    }

    function renderStepper(){
      stepperEl.innerHTML = "";
      steps.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "step-chip" + (i===stepIndex ? " active" : "");
        div.innerHTML = `<span class="badge">${i+1}</span><span>${s.title}</span>`;
        stepperEl.appendChild(div);
      });
    }

    function fieldWrapper(field, inner){
      const wrap = document.createElement("div");
      wrap.className = "row";
      const label = document.createElement("label");
      label.setAttribute("for", field.id);
      label.textContent = field.label;

      const help = document.createElement("p");
      help.className = "help";
      help.textContent = field.help || "";

      wrap.appendChild(label);
      wrap.appendChild(inner);
      if(field.help) wrap.appendChild(help);
      return wrap;
    }

    function renderField(field){
      if(field.type === "select"){
        const sel = document.createElement("select");
        sel.id = field.id;
        sel.name = field.id;
        if(field.required) sel.dataset.required = "true";
        (field.options || []).forEach(opt => {
          const o = document.createElement("option");
          o.value = opt;
          o.textContent = opt === "" ? "Select…" : opt;
          sel.appendChild(o);
        });
        return fieldWrapper(field, sel);
      }

      if(field.type === "textarea"){
        const ta = document.createElement("textarea");
        ta.id = field.id;
        ta.name = field.id;
        ta.placeholder = field.ph || "";
        if(field.required) ta.dataset.required = "true";
        ta.dataset.neutralCheck = "true";
        return fieldWrapper(field, ta);
      }

      if(field.type === "multicheck"){
        const div = document.createElement("div");
        div.className = "multi";
        div.id = field.id;
        div.dataset.type = "multicheck";
        if(field.required) div.dataset.required = "true";

        (field.options || []).forEach((opt, idx) => {
          const lbl = document.createElement("label");
          lbl.className = "check";
          lbl.style.margin = "0";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.name = field.id;
          cb.value = opt;
          cb.id = `${field.id}_${idx}`;
          const span = document.createElement("span");
          span.textContent = opt;
          lbl.appendChild(cb);
          lbl.appendChild(span);
          div.appendChild(lbl);
        });
        return fieldWrapper(field, div);
      }

      if(field.type === "checkbox"){
        const lbl = document.createElement("label");
        lbl.className = "check";
        lbl.style.margin = "0";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = field.id;
        cb.name = field.id;
        if(field.required) cb.dataset.required = "true";
        const span = document.createElement("span");
        span.textContent = field.help || "I agree";
        lbl.appendChild(cb);
        lbl.appendChild(span);

        // wrap without duplicating help text
        const wrap = document.createElement("div");
        wrap.className = "row";
        const title = document.createElement("label");
        title.textContent = field.label;
        wrap.appendChild(title);
        wrap.appendChild(lbl);
        return wrap;
      }

      // default: input
      const input = document.createElement("input");
      input.type = field.type || "text";
      input.id = field.id;
      input.name = field.id;
      input.placeholder = field.ph || "";
      if(field.required) input.dataset.required = "true";
      if(field.type === "number") input.min = "0";
      return fieldWrapper(field, input);
    }

    function renderStep(){
      clearAlert();
      renderStepper();

      const step = steps[stepIndex];
      stepTitle.textContent = step.title;
      stepSub.textContent = step.sub;

      progressLabel.textContent = `Step ${stepIndex+1} of ${steps.length}`;
      barEl.style.width = percent() + "%";

      formEl.classList.remove("fade-enter");
      formEl.innerHTML = "";
      const grid = document.createElement("div");
      grid.className = "grid";

      step.fields.forEach((f, i) => {
        const node = renderField(f);
        grid.appendChild(node);
      });

      formEl.appendChild(grid);
      formEl.classList.add("fade-enter");

      document.getElementById("backBtn").style.visibility = stepIndex === 0 ? "hidden" : "visible";
      document.getElementById("nextBtn").textContent = stepIndex === steps.length - 1 ? "Submit" : "Next";

      // apply draft values if present
      hydrateFromState();
      attachNeutralLanguageChecks();
    }

    function getState(){
      const state = {};
      // inputs + selects + textareas
      formEl.querySelectorAll("input, select, textarea").forEach(el => {
        if(el.type === "checkbox" && el.name && el.name !== el.id){
          // multicheck handled below
          return;
        }
        if(el.type === "checkbox"){
          state[el.id] = el.checked;
        } else {
          state[el.name] = el.value;
        }
      });
      // multicheck groups
      formEl.querySelectorAll("[data-type='multicheck']").forEach(group => {
        const name = group.id;
        const vals = Array.from(group.querySelectorAll("input[type='checkbox']:checked")).map(cb => cb.value);
        state[name] = vals;
      });
      return state;
    }

    function mergeDraft(partial){
      const draft = JSON.parse(localStorage.getItem("directoryDraft") || "{}");
      const merged = { ...draft, ...partial, _lastSavedAt: new Date().toISOString() };
      localStorage.setItem("directoryDraft", JSON.stringify(merged));
      return merged;
    }

    function hydrateFromState(){
      const draft = JSON.parse(localStorage.getItem("directoryDraft") || "{}");
      // hydrate standard fields
      formEl.querySelectorAll("input, select, textarea").forEach(el => {
        if(el.type === "checkbox" && el.name && el.name !== el.id){
          return;
        }
        if(el.type === "checkbox"){
          if(typeof draft[el.id] === "boolean") el.checked = draft[el.id];
        } else {
          if(draft[el.name] != null) el.value = draft[el.name];
        }
      });
      // hydrate multicheck
      formEl.querySelectorAll("[data-type='multicheck']").forEach(group => {
        const name = group.id;
        const vals = Array.isArray(draft[name]) ? draft[name] : [];
        group.querySelectorAll("input[type='checkbox']").forEach(cb => {
          cb.checked = vals.includes(cb.value);
        });
      });
    }

    function validateStep(){
      const step = steps[stepIndex];
      const errors = [];

      // required inputs/selects/textareas
      formEl.querySelectorAll("[data-required='true']").forEach(el => {
        if(el.dataset.type === "multicheck"){
          const checked = el.querySelectorAll("input[type='checkbox']:checked").length;
          if(checked === 0) errors.push("Please select at least one option where required.");
          return;
        }
        if(el.type === "checkbox"){
          if(!el.checked) errors.push("Please confirm the attestation to submit.");
          return;
        }
        if((el.value || "").trim() === "") errors.push("Please complete all required fields before continuing.");
      });

      // specific logic: age range if on eligibility step
      if(step.key === "eligibility"){
        const min = Number((formEl.querySelector("[name='min_age']")?.value || "").trim());
        const max = Number((formEl.querySelector("[name='max_age']")?.value || "").trim());
        if(!Number.isFinite(min) || !Number.isFinite(max)) errors.push("Please enter a valid minimum and maximum age.");
        if(Number.isFinite(min) && Number.isFinite(max) && max < min) errors.push("Maximum age must be greater than or equal to minimum age.");

        // location required for in-person/hybrid (read from draft)
        const draft = JSON.parse(localStorage.getItem("directoryDraft") || "{}");
        const setting = draft.service_setting || "";
        if(setting === "In-person" || setting === "Hybrid"){
          const city = (formEl.querySelector("[name='location_city']")?.value || "").trim();
          const zip = (formEl.querySelector("[name='location_zip']")?.value || "").trim();
          if(!city || !zip) errors.push("For in-person or hybrid programs, please provide a primary city and ZIP.");
        }
      }

      // intake contact requirement
      if(step.key === "intake"){
        const phone = (formEl.querySelector("[name='intake_phone']")?.value || "").trim();
        const email = (formEl.querySelector("[name='intake_email']")?.value || "").trim();
        if(!phone && !email) errors.push("Please provide at least one intake contact method (phone or email).");
      }

      // neutral language soft check on description
      if(step.key === "program"){
        const desc = (formEl.querySelector("[name='program_description_public']")?.value || "").toLowerCase();
        const hits = marketingSoftBlock.filter(w => desc.includes(w));
        if(hits.length){
          // warning only, not blocking
          showAlert(`Neutrality check: consider revising marketing-style terms (${hits.slice(0,6).join(", ")}). Factual language improves trust.`, "warn");
        }
      }

      return errors;
    }

    function attachNeutralLanguageChecks(){
      const ta = formEl.querySelector("[name='program_description_public']");
      if(!ta) return;
      ta.addEventListener("input", () => {
        const v = (ta.value || "").toLowerCase();
        const hits = marketingSoftBlock.filter(w => v.includes(w));
        if(hits.length){
          showAlert(`Neutrality check: consider removing marketing/outcome terms (${hits.slice(0,6).join(", ")}).`, "warn");
        } else {
          clearAlert();
        }
      });
    }

    // --- Navigation ---
    document.getElementById("nextBtn").addEventListener("click", async () => {
      // save current fields into draft
      const snapshot = getState();
      mergeDraft(snapshot);

      const errors = validateStep();
      if(errors.length){
        showAlert(errors[0], "warn");
        return;
      }

      // final submit
if(stepIndex === steps.length - 1){
  const payload = JSON.parse(localStorage.getItem("directoryDraft") || "{}");
  payload._submittedAt = new Date().toISOString();

  const nextBtn = document.getElementById("nextBtn");
  const prevText = nextBtn.textContent;
  nextBtn.disabled = true;
  nextBtn.textContent = "Submitting…";

  // Send to inbox for manual review
  try{
    await submitToFormspree(payload);
    showAlert("Submitted for review. This information has been sent to the directory moderator.", "success");
  }catch(err){
    if(String(err && err.message) === "FORM_ENDPOINT_NOT_CONFIGURED"){
      showAlert("Admin setup required: paste your Formspree endpoint into FORMSPREE_ENDPOINT in the page source.", "warn");
    } else {
      // Fallback: download JSON so the submitter can email it manually
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "program-submission.json";
      a.click();
      URL.revokeObjectURL(url);

      showAlert("We couldn't send this automatically right now, so a JSON file was downloaded instead. Please email it to viablementalhealthresources@gmail.com.", "warn");
    }
  }finally{
    nextBtn.disabled = false;
    nextBtn.textContent = prevText;
  }
  return;
}

stepIndex++;
      renderStep();
    });

    document.getElementById("backBtn").addEventListener("click", () => {
      const snapshot = getState();
      mergeDraft(snapshot);
      stepIndex = Math.max(0, stepIndex - 1);
      renderStep();
    });

    // --- Draft actions ---
    document.getElementById("saveDraft").addEventListener("click", () => {
      const snapshot = getState();
      mergeDraft(snapshot);
      showAlert("Draft saved on this device.", "success");
    });

    document.getElementById("loadDraft").addEventListener("click", () => {
      hydrateFromState();
      showAlert("Draft loaded.", "success");
    });

    document.getElementById("clearDraft").addEventListener("click", () => {
      localStorage.removeItem("directoryDraft");
      renderStep();
      showAlert("Cleared draft data on this device.", "success");
    });

    // initial render
    renderStep();
  </script>
</body>
</html>
