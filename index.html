<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Texas Youth Mental Health Resource Finder</title>
  <meta name="description" content="A neutral directory of adolescent and youth mental health programs across Texas. Filter by level of care, location, and needs." />
  <style>
    :root{
      /* Calm, non-orange palette */
      --bg0:#f7f7fb;
      --bg1:#f3fbff;
      --ink:#0f172a;
      --muted:#475569;
      --card:#ffffffcc;
      --cardSolid:#ffffff;
      --stroke:#e8eef7;
      --shadow: 0 18px 60px rgba(15, 23, 42, .12);
      --shadowSoft: 0 10px 30px rgba(15, 23, 42, .10);
      --radius: 22px;

      --a:#4fd1c5; /* mint */
      --b:#7aa7ff; /* soft blue */
      --c:#c4b5fd; /* lavender */
      --d:#f1f5f9; /* slate tint */

      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#22c55e;

      --focus: 0 0 0 4px rgba(122,167,255,.25);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 12% 10%, rgba(196,181,253,.35), transparent 55%),
        radial-gradient(1000px 700px at 80% 20%, rgba(79,209,197,.28), transparent 55%),
        radial-gradient(900px 700px at 55% 85%, rgba(122,167,255,.20), transparent 50%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    a{color:inherit}
    .container{max-width:1120px;margin:0 auto;padding:28px 18px 70px}

    /* Floating blobs */
    .blob{
      position:absolute; inset:auto;
      width:420px;height:420px;border-radius:999px;
      filter: blur(20px);
      opacity:.45;
      transform: translate3d(0,0,0);
      pointer-events:none;
      mix-blend-mode:multiply;
      animation: floaty 12s ease-in-out infinite;
    }
    .blob.one{left:-120px;top:-120px;background: radial-gradient(circle at 30% 30%, rgba(196,181,253,.9), rgba(122,167,255,.15));}
    .blob.two{right:-160px;top:240px;background: radial-gradient(circle at 30% 30%, rgba(79,209,197,.75), rgba(196,181,253,.10)); animation-duration: 16s;}
    .blob.three{left:20%;bottom:-220px;background: radial-gradient(circle at 30% 30%, rgba(122,167,255,.55), rgba(79,209,197,.10)); animation-duration: 18s;}

    @keyframes floaty{
      0%,100%{transform: translate(0,0) scale(1)}
      50%{transform: translate(18px,-22px) scale(1.03)}
    }

    header{
      position:relative;
      border:1px solid var(--stroke);
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(135deg, rgba(255,255,255,.74), rgba(255,255,255,.50));
      backdrop-filter: blur(12px);
      box-shadow: var(--shadowSoft);
      overflow:hidden;
      padding: 22px 22px 16px;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      margin-bottom: 14px;
    }

    .brand{
      display:flex;align-items:center;gap:12px;
      font-weight:700; letter-spacing:-.02em;
    }
    .mark{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(79,209,197,.9), rgba(196,181,253,.9));
      box-shadow: 0 10px 26px rgba(79,209,197,.25);
      position:relative;
    }
    .mark:after{
      content:"";
      position:absolute; inset:10px 12px 12px 10px;
      border-radius:12px;
      background: rgba(255,255,255,.75);
      transform: rotate(10deg);
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.70);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
    }

    .hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 18px;
      align-items: stretch;
    }
    @media (max-width: 900px){
      .hero{grid-template-columns:1fr; }
    }

    h1{
      margin:0;
      font-size: clamp(26px, 3.2vw, 40px);
      line-height:1.08;
      letter-spacing:-.03em;
    }
    .sub{
      margin:10px 0 0;
      color:var(--muted);
      font-size: 15px;
      line-height:1.55;
      max-width: 60ch;
    }

    .heroCard{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.72);
      padding: 14px 14px 12px;
      display:flex; flex-direction:column; gap: 10px;
      box-shadow: 0 12px 34px rgba(15,23,42,.08);
    }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .9fr .9fr;
      gap: 10px;
      align-items:end;
    }
    @media (max-width: 900px){
      .controls{grid-template-columns:1fr;}
    }

    label{
      font-size: 12px;
      color: var(--muted);
      display:block;
      margin: 0 0 7px 2px;
    }

    input[type="search"], select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      outline:none;
      color: var(--ink);
      box-shadow: 0 8px 20px rgba(15,23,42,.05);
    }
    input[type="search"]:focus, select:focus{ box-shadow: var(--focus); border-color: rgba(122,167,255,.55); }

    .toggleRow{
      display:flex;flex-wrap:wrap;gap:10px; align-items:center; justify-content:space-between;
      padding-top: 6px;
    }
    .toggles{
      display:flex; flex-wrap:wrap; gap: 8px;
    }

    .chip{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.70);
      font-size: 13px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .chip:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(15,23,42,.08);}
    .chip input{ accent-color: #5b8cff; }

    .ctaRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 600;
      box-shadow: 0 10px 24px rgba(15,23,42,.08);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 16px 34px rgba(15,23,42,.12); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(79,209,197,.92), rgba(196,181,253,.92));
      border-color: rgba(255,255,255,.55);
      color: #0b1220;
    }

    /* Results */
    .section{
      margin-top: 18px;
      border:1px solid var(--stroke);
      border-radius: calc(var(--radius) + 8px);
      background: linear-gradient(135deg, rgba(255,255,255,.70), rgba(255,255,255,.42));
      backdrop-filter: blur(10px);
      box-shadow: var(--shadowSoft);
      overflow:hidden;
    }
    .sectionHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke);
    }
    .sectionHead h2{
      margin:0;
      font-size: 14px;
      color: var(--muted);
      letter-spacing:.08em;
      text-transform: uppercase;
    }
    .count{
      font-size: 13px; color: var(--muted);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 14px 14px 16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 640px){ .grid{grid-template-columns: 1fr;} }

    .card{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.82);
      box-shadow: 0 12px 30px rgba(15,23,42,.08);
      padding: 14px;
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease;
      position:relative;
      overflow:hidden;
      animation: rise .35s ease both;
    }
    .card:hover{ transform: translateY(-3px); box-shadow: 0 18px 44px rgba(15,23,42,.14); }

    @keyframes rise{
      from{ opacity:0; transform: translateY(8px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .badgeRow{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(241,245,249,.85);
      color: var(--muted);
    }
    .badge.loc{ background: rgba(122,167,255,.12); border-color: rgba(122,167,255,.25); }
    .badge.loc2{ background: rgba(79,209,197,.12); border-color: rgba(79,209,197,.25); }
    .badge.crisis{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.22); color:#7f1d1d; }

    .title{
      font-weight: 750;
      letter-spacing:-.02em;
      margin:0 0 6px;
      font-size: 16px;
      line-height:1.25;
    }
    .org{ margin:0; color: var(--muted); font-size: 13px; line-height:1.45; }
    .meta{
      margin-top: 12px;
      display:flex; gap:10px; flex-wrap:wrap;
      color: var(--muted);
      font-size: 13px;
    }

    .empty{
      padding: 18px 16px 22px;
      color: var(--muted);
      line-height:1.55;
    }

    /* Drawer */
    .overlay{
      position:fixed; inset:0;
      background: rgba(15,23,42,.40);
      backdrop-filter: blur(4px);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
    }
    .overlay.open{ opacity:1; pointer-events:auto; }

    .drawer{
      position:fixed;
      top:0; right:0; height:100%;
      width:min(520px, 94vw);
      background: rgba(255,255,255,.92);
      border-left: 1px solid var(--stroke);
      box-shadow: -24px 0 70px rgba(15,23,42,.18);
      transform: translateX(110%);
      transition: transform .22s ease;
      display:flex; flex-direction:column;
    }
    .drawer.open{ transform: translateX(0); }

    .drawerHead{
      padding: 16px 16px 12px;
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .drawerTitle{
      margin:0;
      font-size: 18px;
      letter-spacing:-.02em;
    }
    .drawerSub{ margin: 6px 0 0; color: var(--muted); font-size: 13px; line-height:1.4; }
    .closeBtn{
      border:1px solid var(--stroke);
      background: rgba(241,245,249,.85);
      width:40px; height:40px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 800;
    }
    .drawerBody{
      padding: 14px 16px 18px;
      overflow:auto;
    }
    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(226,232,240,.9);
    }
    .k{ color: var(--muted); font-size: 12px; text-transform:uppercase; letter-spacing:.08em;}
    .v{ color: var(--ink); font-size: 14px; line-height:1.45; }

    .callRow{
      margin-top: 14px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .linkBtn{
      display:inline-flex; align-items:center; justify-content:center;
      text-decoration:none;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.9);
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
      font-weight: 650;
    }
    .linkBtn.primary{
      background: linear-gradient(135deg, rgba(122,167,255,.92), rgba(196,181,253,.92));
      border-color: rgba(255,255,255,.55);
    }

    /* Hero illustration */
    .illustration{
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(79,209,197,.18), rgba(196,181,253,.18));
      position:relative;
      overflow:hidden;
      box-shadow: 0 14px 38px rgba(15,23,42,.10);
      min-height: 220px;
      display:flex;align-items:center;justify-content:center;
    }
    .spark{
      position:absolute;
      width:10px; height:10px; border-radius: 999px;
      background: rgba(122,167,255,.85);
      filter: blur(.2px);
      opacity:.65;
      animation: twinkle 2.6s ease-in-out infinite;
    }
    .spark:nth-child(1){left:16%;top:18%;animation-delay:.1s}
    .spark:nth-child(2){left:70%;top:22%;background:rgba(79,209,197,.85);animation-delay:.6s}
    .spark:nth-child(3){left:78%;top:66%;background:rgba(196,181,253,.9);animation-delay:1.1s}
    .spark:nth-child(4){left:22%;top:72%;background:rgba(79,209,197,.85);animation-delay:1.6s}
    @keyframes twinkle{
      0%,100%{transform: scale(1); opacity:.55}
      50%{transform: scale(1.5); opacity:.9}
    }
    /* Hero person: calm "breathing" motion */
.heroHuman {
  transform-origin: 50% 60%;
  animation: breathe 6.5s ease-in-out infinite;
  filter: drop-shadow(0 18px 30px rgba(15,23,42,.10));
}

@keyframes breathe {
  0%, 100% { transform: translateY(0) scale(1); opacity: .98; }
  50%      { transform: translateY(-6px) scale(1.015); opacity: 1; }
}

/* Optional: extra gentle drift on the whole illustration area */
.illustration svg {
  will-change: transform;
}

    footer{
      margin-top: 16px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.6;
      padding: 10px 4px 0;
    }

    .warnBox{
      margin-top: 10px;
      border:1px solid rgba(239,68,68,.18);
      background: rgba(239,68,68,.06);
      border-radius: 16px;
      padding: 10px 12px;
      color:#7f1d1d;
      font-size: 13px;
      line-height:1.45;
      display:none;
    }
    .warnBox.show{display:block;}
  </style>
</head>

<body>
  <div class="blob one"></div>
  <div class="blob two"></div>
  <div class="blob three"></div>

  <div class="container">
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="mark" aria-hidden="true"></div>
          <div>
            <div style="font-size:14px;color:var(--muted);font-weight:700;letter-spacing:.02em">Texas Youth Mental Health</div>
            <div style="font-size:18px;font-weight:850;letter-spacing:-.02em">Resource Finder</div>
          </div>
        </div>
        <div class="pill" title="Neutral directory principles">
          <span aria-hidden="true">●</span>
          <span>Informational • Not ranked • Verify details</span>
        </div>
      </div>

      <div class="hero">
        <div class="heroCard">
          <div>
            <h1>Find the right level of support—clearly, calmly, and without judgment.</h1>
            <p class="sub">
              Search programs by level of care (PHP, IOP, outpatient) and location. Crisis resources are available too, but kept separate by default for clarity.
            </p>
          </div>

          <div class="controls">
            <div>
              <label for="q">Search</label>
              <input id="q" type="search" placeholder="Try: Dallas, Plano, PHP, IOP, ‘virtual’…" autocomplete="off" />
            </div>
            <div>
              <label for="loc">Location</label>
              <select id="loc">
                <option value="">Any</option>
              </select>
            </div>
            <div>
              <label for="care">Level of care</label>
              <select id="care">
                <option value="">Any</option>
                <option value="Partial Hospitalization (PHP)">Partial Hospitalization (PHP)</option>
                <option value="Intensive Outpatient (IOP)">Intensive Outpatient (IOP)</option>
                <option value="Outpatient">Outpatient</option>
                <option value="Navigation">Navigation</option>
              </select>
            </div>
          </div>

          <div class="toggleRow">
            <div class="toggles">
              <label class="chip" title="Show only youth/adolescent-serving entries when age info is available">
                <input id="onlyYouth" type="checkbox" />
                <span>Prioritize youth</span>
              </label>

              <label class="chip" title="Show crisis services (hotlines, mobile crisis, walk-in urgent care)">
                <input id="showCrisis" type="checkbox" />
                <span>Show crisis resources</span>
              </label>

              <label class="chip" title="Show virtual/telehealth offerings when noted">
                <input id="onlyVirtual" type="checkbox" />
                <span>Virtual only</span>
              </label>
            </div>

            <div class="ctaRow">
              <button class="btn" id="reset">Reset</button>
              <button class="btn primary" id="viewAll">View all</button>
            </div>
          </div>

          <div id="loadWarn" class="warnBox"></div>

          <footer>
            If someone is in immediate danger, call 911. This directory is informational and does not provide clinical advice.
          </footer>
        </div>

        <div class="illustration" aria-label="Friendly illustration">
          <div class="spark"></div><div class="spark"></div><div class="spark"></div><div class="spark"></div>

          <!-- Simple “happy person” SVG illustration -->
          <svg width="320" height="240" viewBox="0 0 320 240" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Happy person illustration">
            <defs>
              <linearGradient id="g1" x1="40" y1="10" x2="280" y2="230" gradientUnits="userSpaceOnUse">
                <stop stop-color="#4FD1C5" stop-opacity="0.55"/>
                <stop offset="0.55" stop-color="#C4B5FD" stop-opacity="0.55"/>
                <stop offset="1" stop-color="#7AA7FF" stop-opacity="0.35"/>
              </linearGradient>
              <filter id="soft" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur stdDeviation="10" />
              </filter>
            </defs>

            <path d="M50 190 C 60 120, 110 80, 160 90 C 210 100, 255 135, 270 190 C 230 218, 90 222, 50 190Z" fill="url(#g1)"/>
            <circle cx="230" cy="80" r="32" fill="#ffffff" opacity="0.85" filter="url(#soft)"/>
            <circle cx="88" cy="70" r="22" fill="#ffffff" opacity="0.75" filter="url(#soft)"/>

            <!-- Body -->
            <path d="M130 210 C 128 170, 132 150, 150 138 C 165 128, 185 128, 200 138 C 218 150, 222 170, 220 210"
                  stroke="#0F172A" stroke-opacity="0.75" stroke-width="10" stroke-linecap="round"/>
            <!-- Head -->
            <circle cx="175" cy="110" r="36" fill="#fff" stroke="#0F172A" stroke-opacity="0.75" stroke-width="8"/>
  
            <!-- Smile -->
            <path d="M160 122 C 168 132, 182 132, 190 122" stroke="#0F172A" stroke-opacity="0.7" stroke-width="6" stroke-linecap="round"/>
            <!-- Eyes -->
            <circle cx="164" cy="112" r="3.5" fill="#0F172A" opacity="0.7"/>
            <circle cx="186" cy="112" r="3.5" fill="#0F172A" opacity="0.7"/>
            <!-- Heart -->
            <path d="M250 140 C 250 132, 260 130, 264 136 C 268 130, 278 132, 278 140 C 278 152, 264 160, 264 160 C 264 160, 250 152, 250 140Z"
                  fill="#4FD1C5" opacity="0.8"/>
          </svg>
        </div>
      </div>
    </header>

    <section class="section" id="treatmentSection">
      <div class="sectionHead">
        <h2>Treatment & Navigation</h2>
        <div class="count" id="treatmentCount">0 results</div>
      </div>
      <div class="grid" id="treatmentGrid"></div>
      <div class="empty" id="treatmentEmpty" style="display:none;">
        No matches. Try removing filters, searching by city (e.g., “Plano”), or switching level of care.
      </div>
    </section>

    <section class="section" id="crisisSection" style="display:none;">
      <div class="sectionHead">
        <h2>Crisis resources</h2>
        <div class="count" id="crisisCount">0 results</div>
      </div>
      <div class="grid" id="crisisGrid"></div>
      <div class="empty" id="crisisEmpty" style="display:none;">
        No crisis resources match your filters.
      </div>
    </section>
  </div>

  <div class="overlay" id="overlay" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-label="Program details">
    <div class="drawerHead">
      <div>
        <h3 class="drawerTitle" id="dTitle">Details</h3>
        <p class="drawerSub" id="dSub"></p>
      </div>
      <button class="closeBtn" id="closeDrawer" aria-label="Close">×</button>
    </div>
    <div class="drawerBody" id="dBody"></div>
  </aside>

  <script>
    // ---------- State ----------
    let programs = [];
    let ready = false;

    const els = {
      q: document.getElementById("q"),
      loc: document.getElementById("loc"),
      care: document.getElementById("care"),
      onlyYouth: document.getElementById("onlyYouth"),
      showCrisis: document.getElementById("showCrisis"),
      onlyVirtual: document.getElementById("onlyVirtual"),

      reset: document.getElementById("reset"),
      viewAll: document.getElementById("viewAll"),

      treatmentSection: document.getElementById("treatmentSection"),
      crisisSection: document.getElementById("crisisSection"),

      treatmentGrid: document.getElementById("treatmentGrid"),
      crisisGrid: document.getElementById("crisisGrid"),

      treatmentCount: document.getElementById("treatmentCount"),
      crisisCount: document.getElementById("crisisCount"),

      treatmentEmpty: document.getElementById("treatmentEmpty"),
      crisisEmpty: document.getElementById("crisisEmpty"),

      loadWarn: document.getElementById("loadWarn"),

      overlay: document.getElementById("overlay"),
      drawer: document.getElementById("drawer"),
      closeDrawer: document.getElementById("closeDrawer"),
      dTitle: document.getElementById("dTitle"),
      dSub: document.getElementById("dSub"),
      dBody: document.getElementById("dBody")
    };

    function safeStr(x){ return (x ?? "").toString().trim(); }

    function isCrisis(p){
      return safeStr(p.entry_type).toLowerCase() === "crisis service";
    }

    function locLabel(p){
      const locs = Array.isArray(p.locations) ? p.locations : [];
      const first = locs[0] || {};
      const city = safeStr(first.city);
      const state = safeStr(first.state);
      if (city && state) return `${city}, ${state}`;
      if (city) return city;
      return "Location not listed";
    }

    function hasVirtual(p){
      const setting = safeStr(p.service_setting).toLowerCase();
      if (setting.includes("virtual") || setting.includes("tele")) return true;
      const locs = Array.isArray(p.locations) ? p.locations : [];
      return locs.some(l => safeStr(l.city).toLowerCase() === "virtual");
    }

    function youthLikely(p){
      // Conservative: treat as youth if ages_served indicates adolescent ranges or 17/18 under.
      const a = safeStr(p.ages_served).toLowerCase();
      if (!a) return false;
      return (
        a.includes("adolescent") ||
        a.includes("child") ||
        a.includes("youth") ||
        a.includes("5") || a.includes("6") || a.includes("7") || a.includes("8") || a.includes("9") ||
        a.includes("10") || a.includes("11") || a.includes("12") || a.includes("13") || a.includes("14") ||
        a.includes("15") || a.includes("16") || a.includes("17")
      );
    }

    function buildLocationOptions(list){
      const set = new Set();
      list.forEach(p => {
        (p.locations || []).forEach(l => {
          const c = safeStr(l.city);
          if (c && c.toLowerCase() !== "virtual" && c.toLowerCase() !== "multiple" && c.toLowerCase() !== "n/a") set.add(c);
        });
      });
      const cities = Array.from(set).sort((a,b)=>a.localeCompare(b));
      // reset
      els.loc.innerHTML = '<option value="">Any</option>' + cities.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    }

    function escapeHtml(s){
      return safeStr(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function matchesFilters(p){
      const q = safeStr(els.q.value).toLowerCase();
      const loc = safeStr(els.loc.value).toLowerCase();
      const care = safeStr(els.care.value).toLowerCase();
      const onlyYouth = els.onlyYouth.checked;
      const onlyVirtual = els.onlyVirtual.checked;

      const hay = [
        p.program_name, p.organization, p.level_of_care,
        p.entry_type, p.service_setting, p.ages_served,
        locLabel(p),
        (p.notes || "")
      ].map(safeStr).join(" ").toLowerCase();

      if (q && !hay.includes(q)) return false;

      if (loc){
        const cities = (p.locations || []).map(l => safeStr(l.city).toLowerCase());
        if (!cities.some(c => c === loc)) return false;
      }

      if (care){
        if (safeStr(p.level_of_care).toLowerCase() !== care) return false;
      }

      if (onlyVirtual && !hasVirtual(p)) return false;

      // “Prioritize youth” means:
      // - If we can tell it serves youth, keep it.
      // - If age is unknown, keep it (don’t hide potentially relevant listings).
      if (onlyYouth){
        const a = safeStr(p.ages_served);
        if (a && !youthLikely(p)) return false;
      }

      return true;
    }

    function badgeForCare(p){
      const care = safeStr(p.level_of_care);
      if (!care) return "Unknown";
      return care;
    }

    function createCard(p){
      const crisis = isCrisis(p);
      const loc = locLabel(p);
      const care = badgeForCare(p);

      const div = document.createElement("div");
      div.className = "card";
      div.tabIndex = 0;

      const locBadgeClass = crisis ? "badge crisis" : "badge loc";
      const locBadgeClass2 = crisis ? "badge crisis" : "badge loc2";

      div.innerHTML = `
        <div class="badgeRow">
          <span class="badge ${crisis ? "crisis" : ""}">${escapeHtml(care)}</span>
          <span class="${locBadgeClass}">${escapeHtml(loc)}</span>
          ${hasVirtual(p) ? `<span class="${locBadgeClass2}">Virtual option</span>` : ``}
        </div>
        <p class="title">${escapeHtml(safeStr(p.program_name) || "Program")}</p>
        <p class="org">${escapeHtml(safeStr(p.organization) || "")}</p>
        <div class="meta">
          <span>Age: ${escapeHtml(safeStr(p.ages_served) || "Unknown")}</span>
          <span>Setting: ${escapeHtml(safeStr(p.service_setting) || "Unknown")}</span>
        </div>
      `;

      const open = () => openDrawer(p);
      div.addEventListener("click", open);
      div.addEventListener("keydown", (e) => { if(e.key==="Enter"||e.key===" ") open(); });

      return div;
    }

    function openDrawer(p){
      els.dTitle.textContent = safeStr(p.program_name) || "Details";
      els.dSub.textContent = `${safeStr(p.organization) || ""}${safeStr(p.organization) ? " • " : ""}${locLabel(p)}`;

      const phone = safeStr(p.phone);
      const locs = Array.isArray(p.locations) ? p.locations : [];
      const addresses = locs
        .map(l => {
          const parts = [safeStr(l.address), safeStr(l.city), safeStr(l.state), safeStr(l.zip)].filter(Boolean);
          return parts.join(", ");
        })
        .filter(Boolean);

      const rows = [
        ["Type", safeStr(p.entry_type) || "Unknown"],
        ["Level of care", safeStr(p.level_of_care) || "Unknown"],
        ["Ages served", safeStr(p.ages_served) || "Unknown"],
        ["Setting", safeStr(p.service_setting) || "Unknown"],
        ["Phone", phone || "Not listed"],
        ["Transportation", safeStr(p.transportation_available) || "Unknown"],
        ["Insurance", safeStr(p.insurance_notes) || "Unknown"],
        ["Notes", safeStr(p.notes) || "—"],
        ["Verification", safeStr(p.verification_source) || "—"],
        ["Last verified", safeStr(p.last_verified) || "—"]
      ];

      els.dBody.innerHTML = `
        ${addresses.length ? `
          <div class="kv">
            <div class="k">Address</div>
            <div class="v">${addresses.map(a=>`<div>${escapeHtml(a)}</div>`).join("")}</div>
          </div>
        ` : ``}
        ${rows.map(([k,v]) => `
          <div class="kv">
            <div class="k">${escapeHtml(k)}</div>
            <div class="v">${escapeHtml(v)}</div>
          </div>
        `).join("")}
        <div class="callRow">
          ${phone ? `<a class="linkBtn primary" href="tel:${phone.replace(/[^\d+]/g,"")}">Call</a>` : ``}
        </div>
      `;

      els.overlay.classList.add("open");
      els.drawer.classList.add("open");
    }

    function closeDrawer(){
      els.overlay.classList.remove("open");
      els.drawer.classList.remove("open");
    }

    function render(){
      if (!ready) return;

      const showCrisis = els.showCrisis.checked;

      const filtered = programs.filter(matchesFilters);

      const treatment = filtered.filter(p => !isCrisis(p));
      const crisis = filtered.filter(p => isCrisis(p));

      // Treatment
      els.treatmentGrid.innerHTML = "";
      treatment.forEach((p, idx) => {
        const card = createCard(p);
        card.style.animationDelay = `${Math.min(idx, 18) * 18}ms`;
        els.treatmentGrid.appendChild(card);
      });
      els.treatmentCount.textContent = `${treatment.length} result${treatment.length===1?"":"s"}`;
      els.treatmentEmpty.style.display = treatment.length ? "none" : "block";

      // Crisis
      els.crisisSection.style.display = showCrisis ? "block" : "none";
      if (showCrisis){
        els.crisisGrid.innerHTML = "";
        crisis.forEach((p, idx) => {
          const card = createCard(p);
          card.style.animationDelay = `${Math.min(idx, 18) * 18}ms`;
          els.crisisGrid.appendChild(card);
        });
        els.crisisCount.textContent = `${crisis.length} result${crisis.length===1?"":"s"}`;
        els.crisisEmpty.style.display = crisis.length ? "none" : "block";
      }
    }

    function bind(){
      const on = (el, ev, fn) => el.addEventListener(ev, fn);

      ["input","change"].forEach(ev => {
        on(els.q, ev, render);
        on(els.loc, ev, render);
        on(els.care, ev, render);
        on(els.onlyYouth, ev, render);
        on(els.onlyVirtual, ev, render);
        on(els.showCrisis, ev, render);
      });

      on(els.reset, "click", () => {
        els.q.value = "";
        els.loc.value = "";
        els.care.value = "";
        els.onlyYouth.checked = false;
        els.onlyVirtual.checked = false;
        els.showCrisis.checked = false;
        render();
      });

      on(els.viewAll, "click", () => {
        els.q.value = "";
        els.loc.value = "";
        els.care.value = "";
        els.onlyYouth.checked = false;
        els.onlyVirtual.checked = false;
        // Keep crisis off by default
        render();
        window.scrollTo({ top: document.getElementById("treatmentSection").offsetTop - 10, behavior: "smooth" });
      });

      on(els.overlay, "click", closeDrawer);
      on(els.closeDrawer, "click", closeDrawer);
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeDrawer();
      });
    }

    async function loadPrograms(){
      els.loadWarn.classList.remove("show");
      els.loadWarn.textContent = "";

      try{
        const res = await fetch("programs.json", { cache:"no-store" });
        if(!res.ok) throw new Error(`programs.json not found (HTTP ${res.status}). Make sure it is in the repo root next to index.html.`);
        const data = await res.json();
        if(!data || !Array.isArray(data.programs)) throw new Error("programs.json loaded but missing a top-level `programs` array.");

        programs = data.programs.map(p => ({
          entry_type: p.entry_type || "Treatment Program",
          organization: p.organization || "",
          program_name: p.program_name || "",
          level_of_care: p.level_of_care || "Unknown",
          service_setting: p.service_setting || "Unknown",
          ages_served: p.ages_served || "Unknown",
          locations: Array.isArray(p.locations) ? p.locations : [],
          phone: p.phone || "",
          notes: p.notes || "",
          transportation_available: p.transportation_available || "Unknown",
          insurance_notes: p.insurance_notes || "Unknown",
          verification_source: p.verification_source || "",
          last_verified: p.last_verified || ""
        }));

        buildLocationOptions(programs);
        ready = true;
        render();
      }catch(err){
        console.error(err);
        els.loadWarn.textContent = `Couldn’t load programs.json. ${err.message}`;
        els.loadWarn.classList.add("show");
        ready = true; // render empty state
        programs = [];
        buildLocationOptions(programs);
        render();
      }
    }

    bind();
    loadPrograms();
  </script>
</body>
</html>
